<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>在线聊天服务端</title>
</head>
<link rel="stylesheet" href="./css/chat.css" type="text/css" />
<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<body>
<div class="direct-chat-msg" id="client" style="display: none;" ondblclick="oneByOne(this)">
    <div class="direct-chat-info clearfix">
        <span class="direct-chat-name pull-left" id="client-name"></span>
        <span  class="direct-chat-timestamp" style="margin-left:10px;" id="client-time"></span>
    </div>
    <img class="left-direct-chat-img direct-chat-img" id="client-img" src="">
    <div class="text-chat left-text-chat" id="client-message"></div>
</div>
<div class="direct-chat-msg right" id="server" style="display: none;" ondblclick="oneByOne(this)">
    <div class="direct-chat-info clearfix">
        <span class="direct-chat-name pull-right" id="server-name"></span>
        <span  class="direct-chat-timestamp pull-right" style="margin-right:10px;" id="server-time"></span>
    </div>
    <div class="clearfix"></div>
    <img class="right-direct-chat-img direct-chat-img" id="server-img" src="">
    <div class="text-chat right-text-chat" id="server-message"></div>
</div>
<div id="modal-overlay">
    <div class="modal-data">
        <img src="" onclick="small_img(this)">
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-md-12 text-center">简易在线聊天</div>
        <div class="col-md-12">
            <div class="chat-window" id="chat">
            </div>
            <div class="message-parent">
                <div class="col-md-11 rich send-message" id="message" contenteditable="true">
                </div>
                <button onclick="sendMessage();" type="button" class="btn btn-success btn-lg">Send</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script>
    var oneByOneFd = 0;
    document.onkeydown = function (e) {
        var e = e || event;
        console.log(event.keyCode)
        if (event.keyCode == 13) {
            sendMessage();
        }

        if (event.keyCode == 8 && $('#message').html() == '') {
            oneByOneFd = 0;
            $('#message').attr('placeholder','');
        }
    };

    var ws = new WebSocket('ws://127.0.0.1:8888?name=jeje&img=./img/s.jpg');

    ws.onopen = function (event) {
        console.log('已经连接服务器');
    };
    ws.onclose = function (event) {
        console.log('服务器发生错误');
    };

    ws.onerror = function (event) {
        console.log('服务器异常');
    };

    ws.onmessage = function (event) {
        var data = JSON.parse(event.data);

        if (data.from == 'close') {
            $('#message').html('');
            alert('对方已经离线!');
            return true;
        }

        if (data.from == 'client') {
            title_message();
            try {
                Notification.requestPermission(function(status) {
                    if (status == "granted") {
                        var notification = new Notification("收到新消息:", {
                            dir:  "auto",
                            lang: "zh-CN",
                            tag:   Math.random(),
                            icon: "http://kf.gplqdb.com/img/head_pic.jpg",
                            body:  data.message
                        });
                    }
                });
            } catch(err) {
            }
            var client = $('#client').clone(true);
            client.find('#client-time').html(data.time);
            client.find('#client-name').html(data.name);
            client.find('#client-message').html(data.message);
            client.find('#client-img').attr('src', data.img);
            client.find('#client-img').attr('fd', data.fd);
            $('#chat').append(client);
            client.css('display', 'block');
            $('#message').html('');
            $('#chat').scrollTop($('#chat')[0].scrollHeight + 200);
        }

        if (data.from == 'server') {
            var server = $('#server').clone(true);
            server.find('#server-time').html(data.time);
            server.find('#server-name').html(data.name);
            server.find('#server-message').html(data.message);
            server.find('#server-img').attr('src', './img/s.jpg');
            server.find('#server-img').attr('fd', data.fd);
            $('#chat').append(server);
            server.css('display', 'block');
            $('#message').html('');
            $('#chat').scrollTop($('#chat')[0].scrollHeight + 200);
        }
        console.log(data);
    };

    function oneByOne(obj) {
        $('#message').attr('placeholder', '单独发送消息给' + $(obj).find('.direct-chat-name').html());
        oneByOneFd = $(obj).find('.direct-chat-img').attr('fd');
    }

    function sendMessage() {
        var message =$('#message').html();

        if (message == '') {
            return;
        }

        var data = JSON.stringify({
            message: message,
            oneByOneFd:oneByOneFd,
            name:'JeJe',
            type:'server'
        });
        oneByOneFd = 0;
        ws.send(data);
    }

    var title_msg_timer = '';

    function title_message() {
        clearInterval(title_msg_timer);
        var str = '收到条新消息...';
        document.title = str;
        title_msg_timer = setInterval(function () {
            var arr = str.split('');
            var str2 = arr.shift();
            var newArr = arr.concat(str2);
            str = newArr.join('');
            document.title = str;
        }, 100);
    }

    $('#message').on({
        click: function () {
            clearInterval(title_msg_timer);
            document.title = '在线聊天服务端';
        },
        keydown: function () {
            clearInterval(title_msg_timer);
            document.title = '在线聊天服务端';
        }
    });

    var putUrl = "http://127.0.0.1:8888";
    document.onpaste = function (event) {
        if($(event.target).hasClass('rich')){
            let items = (event.clipboardData || event.originalEvent.clipboardData).items;
            let item = items[items.length - 1];
            if (item.kind === 'file' && (item.type == "image/png" || item.type == "image/jpeg" || item.type == "image/jpg")) {
                var blob = item.getAsFile();
                var reader = new FileReader();

                reader.onload = function (event) {
                    var content = event.target.result;
                    var pic = content.substr(22);
                    $.post(putUrl, {"pic":pic}, function (data){
                        console.log(data);
                        $('#message').append($('<img src="'+data+'" style="height:120px;width: 100px;" onclick="big_img(this)">'))
                    });
                };
                reader.readAsDataURL(blob);
            }
        }
    };

    function big_img(obj) {
        $('#modal-overlay').find('.modal-data').find('img').attr('src', $(obj).attr('src'));
        $('#modal-overlay').css('visibility', 'visible');
    }
    function small_img(obj) {
        $('#modal-overlay').css('visibility', 'hidden');
        $(obj).attr('src', '');
    }
</script>